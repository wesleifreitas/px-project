define(["../../directives/module"],function(e){"use strict";function t(e,t,a,r,n,o,l){n.pxTableReady=!1,n.currentPage=0,n.$watch("pxTableReady",function(e,t){e===!0&&l(n.pxDataGridGetData,0)}),n.reset=function(){n.currentPage=0,n.currentRecordCount=0,n.internalControl.selectedItems=[],n.internalControl.rowsSelected=[],n.rowsSelected=[],angular.isDefined(n.internalControl.checkAll)&&(n.internalControl.checkAll.checked=!1,n.internalControl.checkAll.indeterminate=!1)},n.pxDataGridGetData=function(){n.rowsSelected=[];var e="";e+="l",e+="t",e+="i",e+="p",e+="r";var a={};n.ajaxUrl&&(a.ajax={url:n.ajaxUrl,dataSrc:""}),a.language={processing:"Processando...",search:"Filtrar registros carregados",lengthMenu:"Visualizar _MENU_ registros",info:"Monstrando de _START_ a _END_ no total de _TOTAL_ registros.",infoEmpty:"Nenhum registro encontrado",zeroRecords:"Nenhum registro encontrado",emptyTable:"Nenhum registro encontrado.",infoFiltered:"",paginate:{first:"Primeira",previous:"« Anterior",next:"Próxima »",last:"Última"}},t.isMobile()&&(a.pagingType="simple",a.pageLength=8),a.bFilter=!0,a.bLengthChange=n.lengthChange,a.lengthMenu=n.lengthMenu,a.sDom=e,a.bProcessing=!0,a.aoColumns=n.aoColumns,a.destroy=!0,n.check&&(a.columnDefs=[{targets:0,searchable:!1,orderable:!1,className:"dt-body-center",render:function(e,t,a,r){return"<input type='checkbox'>"}}]),a.order=[],a.rowCallback=function(e,t,a){var r=t.pxDataGridRowNumber;-1!==$.inArray(r,n.rowsSelected)&&($(e).find('input[type="checkbox"]').prop("checked",!0),$(e).addClass("selected"))},requirejs(["datatables"],function(){$("#pxTable").dataTable(a)}),n.pxTableReady=!1,n.dataInit===!0&&n.getData(0,n.rowsProcess),requirejs(["datatables"],function(){$("#pxTable").DataTable();n.internalControl.table=$("#pxTable").DataTable()}),$("#pxTable").on("page.dt",function(){var e=n.internalControl.table.page.info();e.page===e.pages-1&&(n.currentPage=e.page,n.getData(n.nextRowFrom,n.nextRowTo)),0===e.start&&(e.start=1),n.internalControl.table.context[0].oLanguage.sInfo=e.recordsTotal+" registros carregados. Total de registros na base de dados: "+n.recordCount}),n.updateDataTableSelectAllCtrl=function(e){if(1!=!n.check){var t=e.table().node(),a=$('tbody input[type="checkbox"]',t),r=$('tbody input[type="checkbox"]:checked',t),o=$('thead input[name="select_all"]',t).get(0);n.internalControl.checkAll=o,0===r.length?(o.checked=!1,"indeterminate"in o&&(o.indeterminate=!1)):r.length===a.length?(o.checked=!0,"indeterminate"in o&&(o.indeterminate=!1)):(o.checked=!0,"indeterminate"in o&&(o.indeterminate=!0))}},$("#pxTable tbody").on("click",'input[type="checkbox"]',function(e){var t=$(this).closest("tr"),a=n.internalControl.table.row(t).data(),r=a.pxDataGridRowNumber,o=$.inArray(r,n.rowsSelected);this.checked&&-1===o?(n.rowsSelected.push(r),n.internalControl.selectedItems.push(a)):this.checked||-1===o||(n.rowsSelected.splice(o,1),n.internalControl.selectedItems.splice(o,1)),this.checked?t.addClass("selected"):t.removeClass("selected"),n.updateDataTableSelectAllCtrl(n.internalControl.table),n.$apply(function(){n.$eval(n.itemClick)}),e.stopPropagation()}),$("#pxTable").on("click","tbody td, thead th:first-child",function(e){$(this).parent().find('input[type="checkbox"]').trigger("click")}),$('#pxTable thead input[name="select_all"]').on("click",function(e){this.checked?$('#pxTable tbody input[type="checkbox"]:not(:checked)').trigger("click"):$('#pxTable tbody input[type="checkbox"]:checked').trigger("click"),e.stopPropagation()}),$("#pxTable").on("draw",function(){n.updateDataTableSelectAllCtrl(table)})},n.getData=function(a,r){n.internalControl.working=!0;var l=JSON.parse(n.fields);angular.forEach(l,function(e){if(e.filterObject={},angular.isDefined(e.filter)){var a="#"+e.filter,r=e.filter;if(angular.isDefined(angular.element($(a+"_pxComplete").get(0)).scope())&&(a+="_pxComplete",r="selectedItem"),angular.element($(a).get(0)).scope().hasOwnProperty(r)){var n=angular.element($(a).get(0)).scope()[r];if(!angular.isDefined(n))return;var o=e.field,l=n;angular.isDefined(e.filterOptions)&&(o=e.filterOptions.field,n?(l=n[e.filterOptions.selectedItem],angular.isDefined(l)||(l=n[e.filterOptions.selectedItem.toUpperCase()]),"%"===l&&(l=null)):l=null),null!==l&&""!==l?e.filterObject={field:o,value:l}:e.filterObject={}}else e.filterObject={};e.filterObject.value=t.filterOperator(e.filterObject.value,e.filterOperator)}});var i={};i.dsn=e.PROJECT_DSN,i.table=n.table,i.fields=angular.toJson(l),i.orderBy=n.orderBy,i.rows=n.rowsProcess,angular.isDefined(a)&&(i.rowFrom=a),angular.isDefined(r)&&(i.rowTo=r),0===a&&(n.reset(),requirejs(["datatables"],function(){$("#pxTable").DataTable().clear().draw()})),o({method:"POST",url:e.PX_PACKAGE+"system/components/px-data-grid/px-data-grid.cfc?method=getData",dataType:"json",params:i}).success(function(e){if(n.debug&&console.info("grid getData success",e),angular.isDefined(e.fault))alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!");else if(e.qQuery.length>0){angular.forEach(e.qQuery,function(e){n.addRow(e)}),n.recordCount=e.recordCount,n.nextRowFrom=e.rowFrom+n.rowsProcess,n.nextRowTo=e.rowTo+n.rowsProcess;var t=n.internalControl.table;t.page(n.currentPage).draw(!1);var a=t.page.info();0===a.start&&(a.start=1),$("#pxTable_info").html(a.recordsTotal+" registros carregados. Total de registros na base de dados: "+n.recordCount),n.demand?n.internalControl.working=!1:n.getData(n.nextRowFrom,n.nextRowTo)}else n.internalControl.working=!1}).error(function(e,t,a,r){alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!")})},n.addRow=function(e){n.currentRecordCount++;var t={};t.pxDataGridRowNumber=n.currentRecordCount,angular.forEach(JSON.parse(n.fields),function(r){if(angular.isDefined(e[r.field])?t[r.field]=e[r.field]:t[r.field]=e[r.field.toUpperCase()],angular.isDefined(t[r.field])||(t[r.field]=""),r.stringMask)switch(r.stringMask){case"cpf":t[r.field]=a.maskFormat(t[r.field],"###.###.###-##").result;break;case"cnpj":t[r.field]=a.maskFormat(t[r.field],"##.###.###/####-##").result;break;case"cep":t[r.field]=a.maskFormat(t[r.field],"#####-###").result;break;case"brPhone":11===t[r.field].length?t[r.field]=a.maskFormat(t[r.field],"(##) #####-####").result:t[r.field]=a.maskFormat(t[r.field],"(##) #####-####").result;break;default:t[r.field]=a.maskFormat(t[r.field],r.stringMask).result}if(r.moment,r.numeral)switch(r.numeral){case"currency":t[r.field]=numeral(t[r.field]).format("0,0.00");break;default:t[r.field]=numeral(t[r.field]).format(r.numeral)}}),n.internalControl.table.row.add(t).draw()},n.remove=function(){var e=JSON.parse(n.fields);r.remove(n.table,angular.toJson(e),angular.toJson(n.internalControl.selectedItems),function(e){if(e.success){n.internalControl.table.rows(".selected").remove().draw(!1);var t=n.internalControl.table.page.info();0===t.start&&(t.start=1),n.recordCount-=n.rowsSelected.length,$("#pxTable_info").html(t.recordsTotal+" registros carregados. Total de registros na base de dados: "+n.recordCount),n.internalControl.selectedItems=[],n.rowsSelected=[]}else alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!")})}}e.directive("pxDataGrid",["pxConfig","$timeout","$sce",function(e,a,r){return{restrict:"E",replace:!0,transclude:!1,templateUrl:e.PX_PACKAGE+"system/components/px-data-grid/px-data-grid.html",scope:{debug:"=pxDebug",lengthChange:"=pxLengthChange",lengthMenu:"=pxLengthMenu",ajaxUrl:"@pxAjaxUrl",table:"@pxTable",fields:"@pxFields",orderBy:"@pxOrderBy",columns:"@pxColumns",check:"=pxCheck",init:"&pxInit",itemClick:"&pxItemClick",dataInit:"=pxDataInit",rowsProcess:"=pxRowsProcess",demand:"=pxDemand",control:"=pxControl"},link:function(e,t,n){e.rowsProcess=e.rowsProcess||100,angular.isDefined(e.demand)||(e.demand=!0),e.$watch("fields",function(t,a){""!==t&&(t=JSON.parse(t)),e.dataTable="",e.dataTable+="<thead>",e.aoColumns=[],e.columns="";var n=0,o={};angular.forEach(t,function(t){0===n&&e.check&&(e.columns+='<th class="text-left"><input name="select_all" value="1" type="checkbox"></th>',o={},o.mData="pxDataGridRowNumber",e.aoColumns.push(o)),e.columns+='<th class="text-left">'+t.title+"</th>",o={},o.mData=t.field,e.aoColumns.push(o),n++}),e.dataTable+=e.columns,e.dataTable+="</thead>",e.dataTable+="<tbody></tbody>",e.dataTable+="<tfoot>",e.dataTable+=e.columns,e.dataTable+="</tfoot>",e.dataTable=r.trustAsHtml(e.dataTable),e.pxTableReady=!0,e.internalControl=e.control||{},e.internalControl.working=!1,e.internalControl.getData=function(){e.getData(0,e.rowsProcess)},e.internalControl.addRow=function(t){e.addRow(t)},e.internalControl.remove=function(){e.remove()},e.internalControl.selectedItems=[],e.currentRecordCount=0}),a(e.init,0)},controller:t}}]),t.$inject=["pxConfig","pxUtil","pxMaskUtil","pxDataGridService","$scope","$http","$timeout"]});