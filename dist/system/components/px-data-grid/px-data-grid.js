define(["../../directives/module"],function(e){"use strict";function t(e,t,a,r,n,o,l,i,s){l.pxTableReady=!1,l.currentPage=0,l.$watch("pxTableReady",function(e,t){e===!0&&s(l.pxDataGridGetData,0)}),l.reset=function(){l.currentPage=0,l.currentRecordCount=0,l.internalControl.selectedItems=[],l.internalControl.rowsSelected=[],l.rowsSelected=[],angular.isDefined(l.internalControl.checkAll)&&(l.internalControl.checkAll.checked=!1,l.internalControl.checkAll.indeterminate=!1)},l.pxDataGridGetData=function(){l.rowsSelected=[];var e="";e+="l",e+="t",e+="i",e+="p",e+="r";var a={};l.ajaxUrl&&(a.ajax={url:l.ajaxUrl,dataSrc:""}),a.language={processing:"Processando...",search:"Filtrar registros carregados",lengthMenu:"Visualizar _MENU_ registros",info:"Monstrando de _START_ a _END_ no total de _TOTAL_ registros.",infoEmpty:"Nenhum registro encontrado",zeroRecords:"Nenhum registro encontrado",emptyTable:"Nenhum registro encontrado.",infoFiltered:"",paginate:{first:"Primeira",previous:"« Anterior",next:"Próxima »",last:"Última"}},t.isMobile()&&(a.pagingType="simple",a.pageLength=8),a.bFilter=!0,a.bLengthChange=l.lengthChange,a.lengthMenu=l.lengthMenu,a.sDom=e,a.bProcessing=!0,a.aoColumns=l.aoColumns,a.destroy=!0,a.columnDefs=l.columnDefs,a.order=[],a.rowCallback=function(e,t,a){var r=t.pxDataGridRowNumber;-1!==$.inArray(r,l.rowsSelected)&&($(e).find('input[type="checkbox"]').prop("checked",!0),$(e).addClass("selected"))},requirejs(["dataTables"],function(){$("#"+l.id+"_pxDataTable").dataTable(a)}),l.pxTableReady=!1,l.dataInit===!0&&l.getData(0,l.rowsProcess),requirejs(["dataTables"],function(){$("#"+l.id+"_pxDataTable").DataTable();l.internalControl.table=$("#"+l.id+"_pxDataTable").DataTable()}),$("#"+l.id+"_pxDataTable").on("page.dt",function(){var e=l.internalControl.table.page.info();e.page===e.pages-1&&(l.currentPage=e.page,l.getData(l.nextRowFrom,l.nextRowTo)),0===e.start&&(e.start=1),l.internalControl.table.context[0].oLanguage.sInfo=e.recordsTotal+" registros carregados. Total de registros na base de dados: "+l.recordCount}),l.updateDataTableSelectAllCtrl=function(e){if(1!=!l.check){var t=e.table().node(),a=$('tbody input[type="checkbox"]',t),r=$('tbody input[type="checkbox"]:checked',t),n=$('thead input[name="select_all"]',t).get(0);l.internalControl.checkAll=n,0===r.length?(n.checked=!1,"indeterminate"in n&&(n.indeterminate=!1)):r.length===a.length?(n.checked=!0,"indeterminate"in n&&(n.indeterminate=!1)):(n.checked=!0,"indeterminate"in n&&(n.indeterminate=!0))}},$("#"+l.id+"_pxDataTable tbody").on("click",'i[class="fa fa-pencil"]',function(e){var t=$(this).closest("tr");l.internalControl.updatedRow=t;var a=l.internalControl.table.row(t).data(),r={};angular.forEach(l.fields,function(e){r[e.field]=a.edit[e.field]});var n={itemClick:a,itemEdit:r};l.itemEdit({event:n})}),$("#"+l.id+"_pxDataTable tbody").on("click",'input[type="checkbox"]',function(e){var t=$(this).closest("tr"),a=l.internalControl.table.row(t).data(),r=a.pxDataGridRowNumber,n=$.inArray(r,l.rowsSelected);this.checked&&-1===n?(l.rowsSelected.push(r),l.internalControl.selectedItems.push(a)):this.checked||-1===n||(l.rowsSelected.splice(n,1),l.internalControl.selectedItems.splice(n,1)),this.checked?t.addClass("selected"):t.removeClass("selected"),l.updateDataTableSelectAllCtrl(l.internalControl.table),e.stopPropagation()}),$("#"+l.id+"_pxDataTable").on("click","tbody td, thead th:first-child",function(e){var t=$(this).closest("tr"),a=l.internalControl.table.row(t).data(),r={itemClick:a};s(function(){l.itemClick({event:r})},0),"I"!==e.target.tagName&&$(this).parent().find('input[type="checkbox"]').trigger("click")}),$("#"+l.id+'_pxDataTable thead input[name="select_all"]').on("click",function(e){this.checked?$("#"+l.id+'_pxDataTable tbody input[type="checkbox"]:not(:checked)').trigger("click"):$("#"+l.id+'_pxDataTable tbody input[type="checkbox"]:checked').trigger("click"),e.stopPropagation()}),$("#"+l.id+"_pxDataTable").on("draw",function(){l.updateDataTableSelectAllCtrl(table)})},l.getData=function(a,r){l.internalControl.working=!0;var n=l.fields;angular.forEach(n,function(e){if(e.filterObject={},angular.isDefined(e.filter)){var a="#"+e.filter,r=e.filter;if(e.filterGroup?(a+="_groupSearch_inputSearch",r="selectedItem"):angular.isDefined(angular.element($(a+"_inputSearch").get(0)).scope())&&(a+="_inputSearch",r="selectedItem"),angular.isDefined(angular.element($(a).get(0)).scope())&&angular.element($(a).get(0)).scope().hasOwnProperty(r)){var n=angular.element($(a).get(0)).scope()[r];if(!angular.isDefined(n))return;var o=e.field,l=n;angular.isDefined(e.filterOptions)&&(o=e.filterOptions.field,n?(l=n[e.filterOptions.selectedItem],angular.isDefined(l)||(l=n[e.filterOptions.selectedItem.toUpperCase()]),"%"===l&&(l=null)):l=null),null!==l&&""!==l?e.filterObject={field:o,value:l}:e.filterObject={}}else e.filterObject={};e.filterObject.value=t.filterOperator(e.filterObject.value,e.filterOperator)}});var i={};i.dsn=e.PROJECT_DSN,angular.isDefined(l.view)&&""!==l.view?i.table=l.view:i.table=l.table,i.fields=angular.toJson(n),i.orderBy=l.orderBy,i.rows=l.rowsProcess,angular.isDefined(a)&&(i.rowFrom=a),angular.isDefined(r)&&(i.rowTo=r),i.group=l.group,i.groupItem=l.groupItem,i.groupLabel=l.groupLabel,l.where&&(l.where=t.setFilterObject(l.where,!1,e.GROUP_TABLE),i.where=angular.toJson(l.where)),0===a&&(l.reset(),requirejs(["dataTables"],function(){$("#"+l.id+"_pxDataTable").DataTable().clear().draw()})),o.select(i,function(e){if(l.debug&&console.info("px-data-grid "+l.id+" getData",e),angular.isDefined(e.fault))alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!");else if(e.qQuery.length>0){angular.forEach(e.qQuery,function(e){l.addDataRow(e)}),l.recordCount=e.recordCount,l.nextRowFrom=e.rowFrom+l.rowsProcess,l.nextRowTo=e.rowTo+l.rowsProcess;l.internalControl.table;requirejs(["dataTables"],function(){$("#"+l.id+"_pxDataTable").DataTable().page(l.currentPage).draw(!1)}),requirejs(["dataTables"],function(){var e=$("#"+l.id+"_pxDataTable").DataTable().page.info();0===e.start&&(e.start=1),$("#"+l.id+"_pxDataTable_info").html(e.recordsTotal+" registros carregados. Total de registros na base de dados: "+l.recordCount)}),l.demand?l.internalControl.working=!1:l.getData(l.nextRowFrom,l.nextRowTo)}else l.internalControl.working=!1})},l.updateDataRow=function(e){var t=l.internalControl.table.row(l.internalControl.updatedRow).data();angular.forEach(l.fields,function(a){angular.isDefined(t[a.field])&&angular.isDefined(e[a.field])&&(angular.isDefined(a.stringMask)?angular.isDefined(a.pad)?t[a.field]=r.maskFormat(n.pad(a.pad,e[a.field],!0),a.stringMask).result:t[a.field]=r.maskFormat(e[a.field],a.stringMask).result:t[a.field]=e[a.field])}),l.internalControl.table.row(l.internalControl.updatedRow).data(t).draw()},l.addDataRow=function(e){l.currentRecordCount++;var t={};t.pxDataGridRowNumber=l.currentRecordCount,t.edit={},angular.forEach(l.fields,function(a){if(angular.isDefined(e[a.field])?t[a.field]=e[a.field]:t[a.field]=e[a.field.toUpperCase()],angular.isDefined(t[a.field])||(t[a.field]=""),t.edit[a.field]=angular.copy(t[a.field]),a.stringMask){switch(a.stringMask){case"cpf":a.stringMask="###.###.###-##";break;case"cnpj":a.stringMask="##.###.###/####-##";break;case"cep":a.stringMask="#####-###";break;case"brPhone":11===t[a.field].length?a.stringMask="(##) #####-####":a.stringMask="(##) #####-####"}angular.isDefined(a.pad)?t[a.field]=r.maskFormat(n.pad(a.pad,t[a.field],!0),a.stringMask).result:t[a.field]=r.maskFormat(t[a.field],a.stringMask).result}if(a.moment&&""!==t[a.field]&&require(["moment"],function(e){t[a.field]=e(Date.parse(t[a.field])).format(a.moment)}),a.numeral)switch(a.numeral){case"currency":t[a.field]=numeral(t[a.field]).format("0,0.00");break;default:t[a.field]=numeral(t[a.field]).format(a.numeral)}}),requirejs(["dataTables"],function(){$("#"+l.id+"_pxDataTable").DataTable().row.add(t).draw()})},l.removeRow=function(e){l.internalControl.table.rows(e).remove().draw()},l.remove=function(){var e=l.fields,t=JSON.parse(l.config),a=t.table;angular.isDefined(a)||(a=l.table),o.remove(a,angular.toJson(e),angular.toJson(l.internalControl.selectedItems),function(e){if(l.debug&&console.info("pxDataGrid remove: ",e),e.success){l.internalControl.table.rows(".selected").remove().draw(!1);var t=l.internalControl.table.page.info();0===t.start&&(t.start=1),l.recordCount-=l.rowsSelected.length,$("#"+l.id+"_pxDataTable_info").html(t.recordsTotal+" registros carregados. Total de registros na base de dados: "+l.recordCount),l.internalControl.selectedItems=[],l.rowsSelected=[]}else alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!")})}}e.directive("pxDataGrid",["pxConfig","pxArrayUtil","pxUtil","$timeout","$sce","$rootScope",function(e,a,r,n,o,l){return{restrict:"E",replace:!0,transclude:!1,templateUrl:e.PX_PACKAGE+"system/components/px-data-grid/px-data-grid.html",scope:{debug:"=pxDebug",config:"@pxConfig",id:"@id",lengthChange:"=pxLengthChange",lengthMenu:"=pxLengthMenu",ajaxUrl:"@pxAjaxUrl",table:"@pxTable",fields:"@pxFields",orderBy:"@pxOrderBy",group:"=pxGroup",groupItem:"@pxGroupItem",groupLabel:"@pxGroupLabel",where:"@pxWhere",columns:"@pxColumns",check:"=pxCheck",edit:"=pxEdit",init:"&pxInit",itemClick:"&pxItemClick",itemEdit:"&pxItemEdit",dataInit:"=pxDataInit",rowsProcess:"=pxRowsProcess",demand:"=pxDemand",control:"=pxControl"},link:function(t,r,i){angular.isDefined(t.id)&&""!==t.id||console.warn("pxDataGrid: Existe um px-data-grid sem id, isto pode causar sérios problemas em seu código!"),t.id=t.id||"pxTable",t.rowsProcess=t.rowsProcess||100,angular.isDefined(t.demand)||(t.demand=!0),t.$watch("config",function(r,n){if(""!==r){r=JSON.parse(r),t.fields=r.fields,t.dataTable="",t.dataTable+="<thead>",t.aoColumns=[],t.columns="";var i=JSON.parse(t.config);if(t.table=t.table||i.table,t.view=t.view||i.view,t.orderBy=t.orderBy||i.orderBy,t.where=t.where||i.where,t.group=t.group||e.GROUP,angular.isDefined(i.group)&&(t.group=i.group),angular.isDefined(i.groupItem)&&(t.groupItem=i.groupItem),angular.isDefined(i.groupLabel)&&(t.groupLabel=i.groupLabel),t.group===!0){if(""===e.GROUP_ITEM_SUFFIX)t.groupItem=t.groupItem||e.GROUP_ITEM;else if(!angular.isDefined(t.groupItem)){t.groupItem=t.groupItem||t.table+"_"+e.GROUP_ITEM_SUFFIX;for(var s=0;s<e.GROUP_REPLACE.length;s++)t.groupItem=t.groupItem.replace(e.GROUP_REPLACE[s],"")}if(""===e.GROUP_LABEL_SUFFIX)t.groupLabel=t.groupLabel||e.GROUP_LABEL;else if(!angular.isDefined(t.groupLabel)){t.groupLabel=t.groupLabel||e.GROUP_TABLE+"_"+e.GROUP_LABEL_SUFFIX;for(var s=0;s<e.GROUP_REPLACE.length;s++)t.groupLabel=t.groupLabel.replace(e.GROUP_REPLACE[s],"")}}t.group&&-1===a.getIndexByProperty(t.fields,"field",t.groupLabel)&&1===l.globals.currentUser.per_developer&&(""===e.GROUP_ITEM?t.fields.push({title:"Grupo",field:t.groupLabel,type:"string",filter:t.id,filterOperator:"=",filterOptions:{field:t.groupItem,selectedItem:e.GROUP_TABLE+"_"+e.GROUP_ITEM_SUFFIX},filterGroup:!0}):t.fields.push({title:"Grupo",field:t.groupLabel,type:"string",filter:t.id,filterOperator:"=",filterOptions:{field:t.groupItem,selectedItem:e.GROUP_ITEM},filterGroup:!0}));var s=0,d={},c=0;t.columnDefs=[],angular.forEach(t.fields,function(e){0===s&&t.check===!0&&(t.columns+='<th class="text-left" width="1%"><input name="select_all" value="1" type="checkbox"></th>',d={},d.mData="pxDataGridRowNumber",t.aoColumns.push(d),t.columnDefs.push({targets:c,searchable:!1,orderable:!1,className:"dt-body-center",render:function(e,t,a,r){return"<input type='checkbox'>"}}),c++),s++,1===s&&t.edit===!0&&(t.columns+='<th class="text-center" width="1%"><i class=""></i></th>',d={},d.mData="edit",t.aoColumns.push(d),t.columnDefs.push({targets:c,searchable:!1,orderable:!1,className:"dt-body-center",render:function(e,t,a,r){return"<i class='fa fa-pencil'>"}}),c++),e.visible===!1&&t.columnDefs.push({targets:c,visible:!1}),c++,t.columns+='<th class="text-left">'+e.title+"</th>",d={},d.mData=e.field,t.aoColumns.push(d),s++}),t.dataTable+=t.columns,t.dataTable+="</thead>",t.dataTable+="<tbody></tbody>",t.dataTable+="<tfoot>",t.dataTable+=t.columns.replace('<th class="text-left" width="1px"><input name="select_all" value="1" type="checkbox"></th>','<th class="text-left"></th>'),t.dataTable+="</tfoot>",t.dataTable=o.trustAsHtml(t.dataTable),t.pxTableReady=!0,t.where&&(t.where=JSON.parse(r.where))}}),t.internalControl=t.control||{},t.internalControl.working=!1,t.internalControl.getData=function(){t.getData(0,t.rowsProcess)},t.internalControl.addDataRow=function(e){t.addDataRow(e)},t.internalControl.updateDataRow=function(e){t.updateDataRow(e)},t.internalControl.removeRow=function(e){t.removeRow(e)},t.internalControl.remove=function(){t.remove()},t.internalControl.selectedItems=[],t.currentRecordCount=0,n(t.init,0)},controller:t}}]),t.$inject=["pxConfig","pxUtil","pxArrayUtil","pxMaskUtil","pxStringUtil","pxDataGridService","$scope","$http","$timeout"]});