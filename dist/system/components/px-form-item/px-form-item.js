define(["../../directives/module"],function(e){"use strict";e.directive("pxEnter",[function(){return function(e,r,n){r.bind("keydown keypress",function(r){13===r.which&&(e.$apply(function(){e.$eval(n.pxEnter)}),r.preventDefault())})}}]).provider("showErrorsConfig",function(){var e,r;e=!1,r="blur",this.showSuccess=function(r){return e=r},this.trigger=function(e){return r=e},this.$get=function(){return{showSuccess:e,trigger:r}}}).directive("showErrors",["$timeout","showErrorsConfig","$interpolate",function(e,r,n){var t,i,l;return i=function(e){var n;return n=r.trigger,e&&null!=e.trigger&&(n=e.trigger),n},t=function(e){var n;return n=r.showSuccess,e&&null!=e.showSuccess&&(n=e.showSuccess),n},l=function(r,l,o,a){var s,u,c,d,p,f,h,m;if(s=!1,p=r.$eval(o.showErrors),f=t(p),m=i(p),u=l[0].querySelector(".form-control[name]"),d=angular.element(u),c=n(d.attr("name")||"")(r),!c)throw"show-errors element has no child input elements with a 'name' attribute and a 'form-control' class";return d.bind(m,function(){return s=!0,h(a[c].$invalid)}),r.$watch(function(){return a[c]&&a[c].$invalid},function(e){return s?(console.info("invalid",e),h(e)):void 0}),r.$on("show-errors-check-validity",function(){return h(a[c].$invalid)}),r.$on("show-errors-reset",function(){return e(function(){return l.removeClass("has-error"),l.removeClass("has-success"),s=!1},0,!1)}),h=function(e){return l.toggleClass("has-error",e),f?l.toggleClass("has-success",!e):void 0}},{restrict:"A",require:"^form",compile:function(e,r){if(-1===r.showErrors.indexOf("skipFormGroupCheck")&&!e.hasClass("form-group")&&!e.hasClass("input-group"))throw"show-errors element does not have the 'form-group' or 'input-group' class";return l}}}]).directive("pxShowError",["$timeout","$rootScope",function(e,r){return{restrict:"E",require:"^form",replace:!0,transclude:!1,template:'<p class="help-block px-show-error">{{error}}</p>',scope:{element:"@pxElement",confirm:"@pxConfirm",confirmError:"@pxConfirmError",minLengthError:"@pxMinlengthError"},link:function(r,n,t,i){e(r.init,0)},controller:["$scope",function(e){e.init=function(){e.error="";var r=angular.element($("#"+e.element).get(0)),n=r.data("$ngModelController"),t=angular.element($("#"+e.confirm).get(0)),i=t.data("$ngModelController");r.on("keyup blur",function(t){angular.isDefined(e.confirm)&&(String(i.$modelValue)!==String(n.$modelValue)?n.$setValidity("confirm",!1):n.$setValidity("confirm",!0)),n.$invalid?(e.$apply(function(){n.$error.deps?e.error=r.scope().depsError:n.$error.required||n.$error.requiredsearch?e.error="Campo obrigatório":n.$error.email?e.error="E-mail inválido":n.$error.minlength?e.error=e.minLengthError:n.$error.confirm?angular.isDefined(e.confirmError)?e.error=e.confirmError:e.error="Campo não confere":console.warn("px-show-error:","$error ausente",n.$error)}),r.css({borderColor:"#A94442"})):(e.$apply(function(){e.error=""}),r.css({borderColor:"#CCCCCC"}))})}}]}}]).directive("pxValidNumber",[function(){return{require:"?ngModel",link:function(e,r,n,t){t&&(t.$parsers.push(function(e){var r=e.replace(/[^0-9]+/g,"");return e!==r&&(t.$setViewValue(r),t.$render()),r}),r.bind("keypress",function(e){32===e.keyCode&&e.preventDefault()}))}}}]).directive("pxBrCnpjMask",["pxStringUtil","$compile",function(e,r){return{priority:100,restrict:"A",scope:{cleanValue:"@cleanValue"},require:"?ngModel",link:function(e,n,t,i){i&&(angular.isDefined(t.uiMask)||(t.$set("uiMask","99.999.999/9999-99"),r(n)(e)),i.$parsers.push(function(e){if(angular.isDefined(e)){var r=String(e).replace(/[^0-9]+/g,"");return e!==r&&i.$setViewValue(r),r}}),e.value2mask=function(e){i.$setViewValue(e)})},controller:["$scope",function(e){e.pxForm2mask=function(r){e.value2mask(r)}}]}}]).directive("pxBrCpfMask",["$compile",function(e){return{priority:100,restrict:"A",scope:{cleanValue:"@cleanValue"},require:"?ngModel",link:function(r,n,t,i){i&&(angular.isDefined(t.uiMask)||(t.$set("uiMask","999.999.999-99"),e(n)(r)),i.$parsers.push(function(e){if(angular.isDefined(e)){var r=String(e).replace(/[^0-9]+/g,"");return e!==r&&i.$setViewValue(r),r}}),r.value2mask=function(e){i.$setViewValue(e)})},controller:["$scope",function(e){e.pxForm2mask=function(r){e.value2mask(r)}}]}}]).directive("pxBrCepMask",["$compile",function(e){return{priority:100,restrict:"A",scope:{cleanValue:"@cleanValue"},require:"?ngModel",link:function(r,n,t,i){i&&(angular.isDefined(t.uiMask)||(t.$set("uiMask","99999-999"),e(n)(r)),i.$parsers.push(function(e){if(angular.isDefined(e)){var r=String(e).replace(/[^0-9]+/g,"");return e!==r&&i.$setViewValue(r),r}}),r.value2mask=function(e){i.$setViewValue(e)})},controller:["$scope",function(e){e.pxForm2mask=function(r){e.value2mask(r)}}]}}]).directive("pxBrPhoneMask",["$compile",function(e){return{priority:100,restrict:"A",scope:{cleanValue:"@cleanValue",validPhone8:"@validPhone8",validPhone9:"@validPhone9"},bindToController:!1,require:"?ngModel",link:function(r,n,t,i){i&&(angular.isDefined(t.uiMask)||(t.$set("uiMask","(99) 9999-9999?9"),e(n)(r)),r.tempValue=r.tempValue||"",n.bind("focusout",function(e){angular.isDefined(r.cleanValue)&&(r.cleanValue.length<11||!angular.isDefined(r.validPhone8))&&(t.$set("uiMask","(99) 9999-9999"),i.$setViewValue(r.cleanValue),r.validPhone9=!1,r.validPhone8=!0)}),n.bind("focusin",function(e){angular.isDefined(r.cleanValue)&&r.cleanValue.length<11&&(t.$set("uiMask","(99) 9999-9999?9"),i.$setViewValue(r.cleanValue),r.validPhone9=!1,r.validPhone8=!1)}),n.bind("keyup",function(e){"undefined"!=typeof r.cleanValue&&(angular.isDefined(r.cleanValue)?11===r.cleanValue.length&&r.validPhone9===!1||!angular.isDefined(r.validPhone9)?(t.$set("uiMask","(99) ?99999-9999"),i.$setViewValue(r.cleanValue),r.validPhone9=!0,r.validPhone8=!1):(10===r.cleanValue.length&&r.validPhone8===!1||!angular.isDefined(r.validPhone8))&&(t.$set("uiMask","(99) 9999-9999?9"),i.$setViewValue(r.cleanValue),r.validPhone9=!1,r.validPhone8=!0):(r.cleanValue=r.tempValue,11===r.cleanValue.length&&r.validPhone9===!1||!angular.isDefined(r.validPhone9)?(t.$set("uiMask","(99) ?99999-9999"),r.validPhone9=!0,r.validPhone8=!1):(10===r.cleanValue.length&&r.validPhone8===!1||!angular.isDefined(r.validPhone8))&&(t.$set("uiMask","(99) 9999-9999?9"),r.validPhone9=!1,r.validPhone8=!0)))}),i.$parsers.push(function(e){if(angular.isDefined(e)){var n=String(e).replace(/[^0-9]+/g,"");return r.cleanValue=n,e!==n&&i.$setViewValue(n),n}}),r.value2mask=function(e){i.$setViewValue(r.cleanValue)})},controller:["$scope",function(e){e.pxForm2mask=function(r){e.value2mask(r)}}]}}]).directive("pxNumberMask",["$filter","$locale",function(e,r){return{restrict:"A",scope:{cleanValue:"@cleanValue",currency:"=pxCurrency",currencySymbol:"@pxCurrencySymbol",numberSuffix:"@pxNumberSuffix",decimalSeparator:"@pxDecimalSeparator",thousandsSeparator:"@pxThousandsSeparator",numberPrecision:"@pxNumberPrecision",useNegative:"=pxUseNegative",usePositiveSymbol:"=pxUsePositiveSymbol"},require:"?ngModel",link:function(e,n,t,i){function l(e){for(var r="",n=0;n<e.length;n++){var t=e.charAt(n);0===r.length&&"0"===t&&(t=!1),t&&t.match(s)&&(v?r.length<v&&(r+=t):r+=t)}return r}function o(e){if(""===e)return e;for(;e.length<h+1;)e="0"+e;return e}function a(e){if(""===e)return C=!0,e;if(e===c+r.NUMBER_FORMATS.DECIMAL_SEP)return"0";var n=o(l(e)),t="",i=0;0===h&&(p="",a="");var a=n.substr(n.length-h,h),s=n.substr(0,n.length-h);if(n=0===h?s:s+p+a,f||""!==$.trim(f)){for(var u=s.length;u>0;u--){var v=s.substr(u-1,1);i++,i%3===0&&(v=f+v),t=v+t}t.substr(0,1)===f&&(t=t.substring(1,t.length)),n=0===h?t:t+p+a}return!m||0===s&&0===a||(n=-1!==e.indexOf("-")&&e.indexOf("+")<e.indexOf("-")?"-"+n:g?"+"+n:""+n),c&&(n=c+n),d&&(n+=d),n}if(n.css({zIndex:0}),i){var s=/[0-9]/,u=e.pxCurrency||!1,c=e.currencySymbol||"",d=e.numberSuffix||"",p=e.decimalSeparator||r.NUMBER_FORMATS.DECIMAL_SEP,f=e.thousandsSeparator||r.NUMBER_FORMATS.GROUP_SEP,h=Number(e.numberPrecision)||2,m=e.useNegative||!1,g=e.usePositiveSymbol||!1;u&&""===c&&(c=r.NUMBER_FORMATS.CURRENCY_SYM);var v=!1,C=!0;i.$parsers.push(function(e){var r="";return"0"===e||""===e&&C!==!1?"0"===e.trim()&&C===!0?0:(C=!0,""):(r=a(e),e!==r&&(i.$setViewValue(r),i.$render()),isNaN(numeral().unformat(r))?0:numeral().unformat(r))})}}}}]).directive("pxGroupShow",["$rootScope","$timeout",function(e,r){return{restrict:"A",require:"?ngModel",link:function(n,t,i,l){1!==e.globals.currentUser.per_developer&&t.hide(),r(function(){var e=angular.element($("#"+i.pxGroupShow).get(0)),r=e.data("$ngModelController");r&&r.$setValidity("required",!0)},0)}}}]).directive("pxGroup",["pxConfig","$rootScope","$mdDialog",function(e,r,n){return{restrict:"E",scope:{id:"@id",required:"@required",control:"=pxControl",placeholder:"@placeholder",inputClass:"@pxInputClass",selectedItem:"=pxSelectedItem",searchClick:"&pxSearchClick",templateUrl:"@pxTemplateUrl","for":"@for"},templateUrl:e.PX_PACKAGE+"system/components/px-form-item/px-group.html",link:function(t,i,l,o){function a(e,r){e.callback=function(n){e.groupSearchControl.setValue(n.itemClick),r.hide()}}1!==r.globals.currentUser.per_developer&&(i.hide(),1===i.parent().children().length&&i.parent().hide()),""===e.GROUP_ITEM&&""===e.GROUP_LABEL?t.groupSearchConfig={table:e.GROUP_TABLE,fields:[{title:"",labelField:!0,field:e.GROUP_TABLE+"_"+e.GROUP_LABEL_SUFFIX,search:!0,type:"string",filterOperator:"%LIKE%"},{title:"",field:e.GROUP_TABLE+"_"+e.GROUP_ITEM_SUFFIX}]}:t.groupSearchConfig={fields:[{title:"",labelField:!0,field:e.GROUP_LABEL,search:!0,type:"string",filterOperator:"%LIKE%"},{title:"",field:e.GROUP_ITEM}]},t.groupSearchControl={},t.groupSearchClick=function(){t.templateUrl&&""!==t.templateUrl?n.show({scope:t,preserveScope:!0,controller:a,templateUrl:t.templateUrl,parent:angular.element(document.body),targetEvent:event,clickOutsideToClose:!0}):t.searchClick({event:event})},a.$inject=["$scope","$mdDialog"]}}}]).directive("pxInputSearch",["pxConfig","pxUtil","pxArrayUtil","$parse","$http","$sce","$timeout","$mdDialog",function(e,r,n,t,i,l,o,a){return{restrict:"E",scope:{debug:"=pxDebug",id:"@id",config:"@pxConfig",required:"@required",control:"=pxControl",placeholder:"@placeholder",inputClass:"@pxInputClass",complete:"=pxComplete",table:"@pxTable",fields:"@pxFields",orderBy:"@pxOrderBy",recordCount:"@pxRecordCount",where:"@pxWhere",selectedItem:"=pxSelectedItem",url:"@pxUrl",responseQuery:"@pxResponseQuery",localQuery:"@pxLocalQuery",searchFields:"@searchfields",dialog:"=pxDialog",searchClick:"&pxSearchClick",dependencies:"@pxDependencies"},require:"?ngModel",templateUrl:e.PX_PACKAGE+"system/components/px-form-item/px-input-search.html",link:function(t,l,a,s){if(s){t.inputClass=t.inputClass||"form-control",t.dialog?t.inputGroup="input-group":t.inputGroup="",t.lastSearchTerm=null,t.currentIndex=null,t.justChanged=!1,t.searchTimer=null,t.hideTimer=null,t.searching=!1,t.pause=400,t.minLength=3,t.searchStr=null,t.internalControl=t.control||{},t.internalControl.working=!1,t.internalControl.selectedItem=null,t.internalControl.setValue=function(e){t.setValue(e)},t.internalControl.getValue=function(){return{selectedItem:t.selectedItem}},o(function(){var e=angular.element($("#"+t.id+"_inputSearch").get(0));e.on("blur",function(e){t.setValidity()});try{var n=JSON.parse(t.config);if(t.table=t.table||n.table,t.fields=t.fields||n.fields,t.orderBy=t.orderBy||n.orderBy,t.recordCount=t.recordCount||n.recordCount,t.where=t.where||n.where,t.dependencies=[],Array.isArray(t.where))for(var i=0;i<t.where.length;i++)t.where[i].required===!0&&t.dependencies.push(t.where[i])}catch(l){console.error("px-form-item: configuração do campo "+t.id+" inválida")}if(t.dependencies)for(var i=0;i<t.dependencies.length;i++){var o=r.getFieldValueObject(t.dependencies[i]);o.element.on("blur",function(e){var n=r.getFieldValueObject({filter:$(this).attr("id")}),i=angular.element($("#"+$(this).attr("id")).get(0));(null===n.value||""===n.value||n.value!==i.scope().oldValue)&&t.clear(),i.scope().oldValue=angular.copy(n.value)})}},0),t.setValidity=function(){var e=angular.element($("#"+t.id+"_inputSearch").get(0)),r=angular.element($("#"+t.id+"_spanInputSearch").get(0));if(angular.isDefined(t.selectedItem)&&null!==t.selectedItem){var i="";angular.isDefined(t.selectedItem)&&(t.labelField=t.fields[n.getIndexByProperty(t.fields,"labelField",!0)].field,i=t.selectedItem[t.labelField],angular.isDefined(i)||(i=t.selectedItem[t.labelField.toUpperCase()])),t.searchStr!==i?($scope.clear(),s.$setValidity("requiredsearch",!1)):(s.$setValidity("requiredsearch",!0),s.$setValidity("required",!0))}else s.$setValidity("requiredsearch",!1),t.clear();o(function(){e.trigger("keyup")},0),a.required===!0&&(s.$invalid?(e.css({borderColor:"#A94442"}),r.css({borderColor:"#A94442"})):(e.css({borderColor:"#CCCCCC"}),r.css({borderColor:"#CCCCCC"})))};var u=function(e,r){return e.length>=t.minLength&&e!==r};if(t.complete===!0){t.processResults=function(e,r,n){if(e&&e.length>0){t.results=[];for(var i=0;i<e.length;i++){for(var l="",o="",a=0;a<n.length;a++){var s="";n[a].labelField&&(s=e[i][n[a].field],angular.isDefined(s)||(s=e[i][n[a].field.toUpperCase()]),l+=n[a].title+s+""),n[a].descriptionField&&(s=e[i][n[a].field],angular.isDefined(s)||(s=e[i][n[a].field.toUpperCase()]),o+=n[a].title+s+" ")}var u={title:l,description:o,item:e[i]};t.results[t.results.length]=u}}else t.results=[]},t.searchTimerComplete=function(n){var l=t.fields;if(n.length>=t.minLength)if(t.localQuery)console.warn("px-complete:","função localQuery não implementada!"),t.searching=!1,t.processResults(JSON.parse(t.localQuery),n);else{angular.forEach(l,function(e){e.search&&(e.filterObject={},e.filterObject={field:e.field,value:r.filterOperator(n,e.filterOperator)})});var o={};o.dsn=e.PROJECT_DSN,o.table=t.table,o.table=t.table,o.fields=angular.toJson(l),o.orderBy=t.orderBy,t.where=r.setFilterObject(t.where,!1,t.table),o.where=angular.toJson(t.where),angular.isDefined(t.recordCount)&&""!==t.recordCount||(t.recordCount=4),o.rows=t.recordCount,angular.isDefined(t.url)&&""!==t.url||(t.url=e.PX_PACKAGE+"system/components/px-form-item/px-form-item.cfc?method=getData"),i({method:"POST",url:t.url,dataType:"json",params:o}).success(function(e,r,i,o){t.debug&&console.info("px-input-search getData success",e),angular.isDefined(t.responseQuery)&&""!==t.responseQuery||(t.responseQuery="qQuery"),t.searching=!1,t.processResults(t.responseQuery?e[t.responseQuery]:e,n,l)}).error(function(e,r,n,t){alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!")})}},t.hideResults=function(){t.hideTimer=o(function(){t.showDropdown=!1},t.pause)},t.resetHideResults=function(){t.hideTimer&&o.cancel(t.hideTimer)},t.hoverRow=function(e){t.currentIndex=e},t.keyPressed=function(e){38!==e.which&&40!==e.which&&13!==e.which?t.searchStr&&""!==t.searchStr?u(t.searchStr,t.lastSearchTerm)?(t.lastSearchTerm=t.searchStr,t.showDropdown=!0,t.currentIndex=-1,t.results=[],t.searchTimer&&o.cancel(t.searchTimer),t.searching=!0,t.searchTimer=o(function(){t.searchTimerComplete(t.searchStr)},t.pause)):t.hasDependencies():(t.showDropdown=!1,t.lastSearchTerm=null):e.preventDefault()},t.selectResult=function(e){t.searchStr=t.lastSearchTerm=e.title,t.internalControl.selectedItem=t.selectedItem=e.item,t.showDropdown=!1,t.results=[],t.setValidity()};var c=l.find("input");c.on("keyup",t.keyPressed),l.on("keyup",function(e){40===e.which?(t.results&&t.currentIndex+1<t.results.length&&(t.currentIndex++,t.$apply(),e.preventDefault(),e.stopPropagation()),t.$apply()):38===e.which?t.currentIndex>=1&&(t.currentIndex--,t.$apply(),e.preventDefault(),e.stopPropagation()):13===e.which?t.results&&t.currentIndex>=0&&t.currentIndex<t.results.length?(t.selectResult(t.results[t.currentIndex]),t.$apply(),e.preventDefault(),e.stopPropagation()):(t.results=[],t.$apply(),e.preventDefault(),e.stopPropagation()):27===e.which?(t.results=[],t.showDropdown=!1,t.$apply()):8===e.which&&(t.selectedItem=null,t.$apply())}),t.showDialog=function(e){t.hasDependencies()||(t.clear(),t.searchClick({event:e}))},t.hasDependencies=function(){if(t.dependencies)for(var e=0;e<t.dependencies.length;e++){var n=r.getFieldValueObject(t.dependencies[e]);if(null===n.value||""===n.value)return n.element.trigger("blur"),alert(t.dependencies[e].message),s.$setValidity("deps",!1),t.setValidity(),!0}return s.$setValidity("deps",!0),!1}}}},controller:["$scope",function(e){e.setValue=function(r){var t=e.fields,i=t[n.getIndexByProperty(t,"labelField",!0)].field,l=r[i];angular.isDefined(l)||(l=r[i.toUpperCase()]),e.searchStr=e.lastSearchTerm=l,e.internalControl.selectedItem=e.selectedItem=r,e.showDropdown=!1,e.results=[],e.setValidity()},e.clear=function(){e.searchStr=e.lastSearchTerm="",e.selectedItem=null,e.showDropdown=!1,e.results=[],e.internalControl.selectedItem=null}}]}}])});