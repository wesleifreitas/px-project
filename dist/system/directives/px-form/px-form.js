define(["../../directives/module"],function(e){"use strict";function l(e,l,a,n,i,t,r,o){i.insertUpdate=function(a){var n=JSON.parse(i.config),t={},u=n.table,s=n.fields;if(angular.isDefined(u)||(u=i.table),angular.isDefined(s)||(s=JSON.parse(i.fields)),i.group=i.group||e.GROUP,angular.isDefined(n.group)&&(i.group=n.group),angular.isDefined(n.groupItem)&&(i.groupItem=n.groupItem),angular.isDefined(n.groupLabel)&&(i.groupLabel=n.groupLabel),i.table=u,i.group===!0){if(""===e.GROUP_SUFFIX)i.groupItem=i.groupItem||e.GROUP_ITEM;else if(!angular.isDefined(i.groupItem)){i.groupItem=i.groupItem||i.table+"_"+e.GROUP_ITEM_SUFFIX;for(var d=0;d<e.GROUP_REPLACE.length;d++)i.groupItem=i.groupItem.replace(e.GROUP_REPLACE[d],"")}if(""===e.GROUP_SUFFIX)i.groupLabel=i.groupLabel||e.GROUP_LABEL;else if(!angular.isDefined(i.groupLabel)){i.groupLabel=i.groupLabel||e.GROUP_TABLE+"_"+e.GROUP_LABEL_SUFFIX;for(var d=0;d<e.GROUP_REPLACE.length;d++)i.groupLabel=i.groupLabel.replace(e.GROUP_REPLACE[d],"")}}angular.forEach(s,function(l){if(l.valueObject={},angular.isDefined(l.insert)||l.identity===!0?angular.isDefined(l.insert)||(l.insert=!1):l.insert=!0,angular.isDefined(l.update)||l.identity===!0?angular.isDefined(l.update)||(l.update=!1):l.update=!0,angular.isDefined(l.hash)&&l.hash&&(angular.isDefined(l.algorithm)||(l.algorithm="SHA-512")),angular.isDefined(l.element)){var n="#"+l.element,u=l.element;angular.isDefined(angular.element($(n+"_inputSearch").get(0)).scope())&&(n+="_inputSearch",u="selectedItem");var s=angular.element($(n).get(0));if(l.selectorName=n,!l.uniqueControl==!0&&s.bind("keyup",function(e){var l=angular.element($("#"+e.target.id).get(0)).data("$ngModelController");t["#"+e.target.id]!==l.$modelValue&&(angular.forEach(t,function(e,l){var a=angular.element($(l).get(0)),n=a.data("$ngModelController");n.$setValidity("unique",!0),r(function(){a.trigger("keyup")},0)}),t={},$(this).unbind(e))}),l.uniqueControl=angular.copy(!0),"undefined"==typeof s[0]&&console.error("pxForm: elemento não encontrado no html, verifique a propriedade element",l),s[0].hasOwnProperty("type")&&"checkbox"===s[0].type&&(angular.isDefined(s.scope()[u])&&""!==s.scope()[u]||(s.scope()[u]=!1),angular.isDefined(l.fieldValueOptions)&&(s.scope()[u]===!0?s.scope()[u]=l.fieldValueOptions.checked:s.scope()[u]=l.fieldValueOptions.unchecked)),s.scope().hasOwnProperty(u)){var d=s.scope()[u];if(!angular.isDefined(d))return void(1!==o.globals.currentUser.per_developer&&l.field===i.groupItem&&(""===e.GROUP_ITEM?l.valueObject={field:l.field,value:o.globals.currentUser[(e.GROUP_TABLE+"_"+e.GROUP_ITEM_SUFFIX).toLowerCase()]}:l.valueObject={field:l.field,value:o.globals.currentUser[e.GROUP_ITEM.toLowerCase()]}));var c=l.field,p=d;angular.isDefined(l.fieldValueOptions)&&"checkbox"!==s[0].type&&(c=l.fieldValueOptions.field,d?(p=d[l.fieldValueOptions.selectedItem],angular.isDefined(p)||(p=d[l.fieldValueOptions.selectedItem.toUpperCase()]),"%"===p&&(p=null)):p=null,angular.isDefined(s.scope().labelField)?angular.isDefined(d[s.scope().labelField])?l.labelField={field:s.scope().labelField,value:d[s.scope().labelField]}:l.labelField={field:s.scope().labelField,value:d[s.scope().labelField.toUpperCase()]}:angular.isDefined(l.fieldValueOptions.selectedLabel)&&(l.labelField={field:l.labelField,value:d[l.fieldValueOptions.selectedLabel]})),null!==p&&""!==p?l.valueObject={field:c,value:p}:"string"===l.type?l.valueObject={field:c,value:""}:(l.valueObject={},l.insert=!1,l.update=!1)}else l.valueObject={},l.insert=!1,l.update=!1}else angular.isDefined(l.user)&&l.user?(l.type="int",l.valueObject={field:l.field,value:o.globals.currentUser.usu_id}):angular.isDefined(l.insertGetDate)&&l.insertGetDate?"insert"===a?(l.type="datetime",l.valueObject={field:l.field,value:"",getDate:!0}):l.update=!1:angular.isDefined(l.updateGetDate)&&l.updateGetDate?(l.type="datetime",l.valueObject={field:l.field,value:"",getDate:!0}):!angular.isDefined(l["default"])||angular.isDefined(l.valueObject.value)&&null!==l.valueObject.value&&""!==l.valueObject.value?l.valueObject={field:l.field,value:""}:l.valueObject.value=l["default"]}),i.debug&&(console.group("$scope.insertUpdate"),console.info("action:",a),console.info("table:",u),console.info("fields (new):",s),console.info("oldForm:",i.oldForm),console.groupEnd());var c="";angular.isDefined(i.oldForm)&&(c=angular.toJson(i.oldForm)),l.insertUpdate(a,u,angular.toJson(s),c,function(e){i.debug&&console.info("pxFormService.insertUpdate response: ",e),e.data.success?(e.data.unique?angular.forEach(s,function(e){if(e.pk===!0){var l=angular.element($(e.selectorName).get(0)),a=l.data("$ngModelController");a.$setValidity("unique",!1),t[e.selectorName]=angular.copy(a.$modelValue),r(function(){l.trigger("blur")},0)}}):i.clean(),i.callback&&i.callback({event:e.data})):alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!")})},i.select=function(e){r(function(){var t=JSON.parse(i.config),o=t.table,u=t.view,s=t.fields;angular.isDefined(o)||(o=i.table),angular.isDefined(u)||(u=i.view),angular.isDefined(s)||(s=JSON.parse(i.fields)),angular.forEach(s,function(l){if(l.valueObject={},l.valueObject.value=e[l.field],angular.isDefined(l.select)?l.select=!1:l.select=!0,angular.isDefined(angular.element($("#"+l.element+"_inputSearch").get(0)).scope()))if(""!==angular.element($("#"+l.element+"_inputSearch").get(0)).scope().fields){var a=angular.element($("#"+l.element+"_inputSearch").get(0)).scope().fields;angular.forEach(a,function(e){e.labelField&&s.push({field:e.field,select:!0})})}else console.error("pxForm: componente px-input-search com propriedade fields inválida",l)}),i.debug&&(console.group("$scope.select"),console.info("table:",o),console.info("view:",u),console.info("fields:",s),console.groupEnd()),angular.isDefined(u)&&""!==u&&(o=u),l.select(o,angular.toJson(s),function(e){i.debug&&console.info("pxFormService.select response: ",e),e.data.success?(i.oldForm=e.data.qQuery[0],angular.forEach(s,function(l){if(angular.isDefined(l.element)){var i="#"+l.element,t=l.element,o=!1;if(angular.isDefined(angular.element($(i+"_inputSearch").get(0)).scope())){i+="_inputSearch",t="selectedItem";var o=!0}var u=angular.element($(i).get(0)),s=String(e.data.qQuery[0][l.field]);if(angular.isDefined(e.data.qQuery[0][l.field])||(s=String(e.data.qQuery[0][l.field.toUpperCase()])),!angular.isDefined(u[0]))return void console.error("pxForm: elemento não encontrado no html, verifique a propriedade element",l);if("checkbox"===u[0].type?s=angular.isDefined(l.fieldValueOptions)?String(l.fieldValueOptions.checked)===String(s)?!0:!1:"1"===s?!0:!1:l.pad&&(s=n.pad(l.pad,s,!0)),angular.isDefined(l.fieldValueOptions)&&"checkbox"!==u[0].type)if(u.scope().hasOwnProperty(t))if(o){var d=angular.copy(e.data.qQuery[0]);angular.isDefined(l.fieldValueOptions.selectedItem)||console.error("pxForm: selectedItem não definido em fieldValueOptions",l),d[l.fieldValueOptions.selectedItem]=s,u.scope().setValue(d)}else("bigint"===l.type||"bit"===l.type||"decimal"===l.type||"double"===l.type||"float"===l.type||"integer"===l.type||"money"===l.type||"money4"===l.type||"numeric"===l.type||"real"===l.type||"smallint"===l.type||"tinyint"===l.type||"int"===l.type)&&(s=Number(s)),u.scope()[l.field]=u.scope()[l.field][a.getIndexByProperty(u.scope()[l.field],l.fieldValueOptions.selectedItem,s)];else console.error("pxForm:","Scope "+t+" sem valor inicial definido");else u.scope().pxForm=!0,angular.isDefined(u.scope().pxForm2mask)&&(u.scope().cleanValue=s,u.scope().pxForm2mask(s)),u.scope()[l.field]=s,r(function(){u.trigger("keyup")},0)}}),i.callback&&(e.data.action="select",i.callback({event:e.data}))):alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!")})},0)},i.clean=function(){if(angular.isDefined(i.config)&&""!==i.config){var e=JSON.parse(i.config),l=e.table,a=e.fields;angular.isDefined(l)||(l=i.table),angular.isDefined(a)||(a=JSON.parse(i.fields)),angular.forEach(a,function(e){if(e.valueObject={},angular.isDefined(e.element)){var l="#"+e.element,a=e.element;angular.isDefined(angular.element($(l+"_inputSearch").get(0)).scope())&&(l+="_inputSearch",a="selectedItem");var n=angular.element($(l).get(0)),i="";angular.isDefined(e.fieldValueOptions)?n.scope().hasOwnProperty(a)&&(n.scope()[e.field]=i):n.scope()[e.field]=i}})}}}e.directive("pxForm",["$timeout",function(e){return{restrict:"E",replace:!1,transclude:!1,template:"<div></div>",scope:{debug:"=pxDebug",config:"@pxConfig",view:"@pxView",table:"@pxTable",fields:"@pxFields",init:"&pxInit",callback:"&pxCallback",control:"=pxControl"},link:function(l,a,n){l.internalControl=l.control||{},l.internalControl.insert=function(){l.insertUpdate("insert")},l.internalControl.select=function(e){l.select(e)},l.internalControl.update=function(){l.insertUpdate("update")},l.internalControl.clean=function(){l.clean()},e(l.init,0)},controller:l}}]),l.$inject=["pxConfig","pxFormService","pxArrayUtil","pxStringUtil","$scope","$http","$timeout","$rootScope"]});