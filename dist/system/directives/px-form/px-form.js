define(["../../directives/module"],function(e){"use strict";function a(e,a,l,n,i,t,r,o,u){i.insertUpdate=function(l){var n=JSON.parse(i.config),t={},s=n.table,d=n.fields;if(angular.isDefined(s)||(s=i.table),angular.isDefined(d)||(d=JSON.parse(i.fields)),i.group=i.group||e.GROUP,angular.isDefined(n.group)&&(i.group=n.group),angular.isDefined(n.groupItem)&&(i.groupItem=n.groupItem),angular.isDefined(n.groupLabel)&&(i.groupLabel=n.groupLabel),i.table=s,i.group===!0){if(""===e.GROUP_SUFFIX)i.groupItem=i.groupItem||e.GROUP_ITEM;else if(!angular.isDefined(i.groupItem)){i.groupItem=i.groupItem||i.table+"_"+e.GROUP_ITEM_SUFFIX;for(var c=0;c<e.GROUP_REPLACE.length;c++)i.groupItem=i.groupItem.replace(e.GROUP_REPLACE[c],"")}if(""===e.GROUP_SUFFIX)i.groupLabel=i.groupLabel||e.GROUP_LABEL;else if(!angular.isDefined(i.groupLabel)){i.groupLabel=i.groupLabel||e.GROUP_TABLE+"_"+e.GROUP_LABEL_SUFFIX;for(var c=0;c<e.GROUP_REPLACE.length;c++)i.groupLabel=i.groupLabel.replace(e.GROUP_REPLACE[c],"")}}angular.forEach(d,function(a){if(a.valueObject={},angular.isDefined(a.insert)||a.identity===!0?angular.isDefined(a.insert)||(a.insert=!1):a.insert=!0,angular.isDefined(a.update)||a.identity===!0?angular.isDefined(a.update)||(a.update=!1):a.update=!0,angular.isDefined(a.hash)&&a.hash&&(angular.isDefined(a.algorithm)||(a.algorithm="SHA-512")),angular.isDefined(a.element)){var n="#"+a.element,s=a.element;angular.isDefined(angular.element($(n+"_inputSearch").get(0)).scope())&&(n+="_inputSearch",s="selectedItem");var d=angular.element($(n).get(0));if(a.selectorName=n,!a.uniqueControl==!0&&d.bind("keyup",function(e){var a=angular.element($("#"+e.target.id).get(0)).data("$ngModelController");t["#"+e.target.id]!==a.$modelValue&&(angular.forEach(t,function(e,a){var l=angular.element($(a).get(0)),n=l.data("$ngModelController");n.$setValidity("unique",!0),r(function(){l.trigger("keyup")},0)}),t={},$(this).unbind(e))}),a.uniqueControl=angular.copy(!0),"undefined"==typeof d[0]&&console.error("pxForm: elemento não encontrado no html, verifique a propriedade element",a),"object"==typeof d[0]&&"checkbox"===d[0].type&&(angular.isDefined(d.scope()[s])&&""!==d.scope()[s]||(d.scope()[s]=!1),angular.isDefined(a.fieldValueOptions)&&(d.scope()[s]===!0?d.scope()[s]=a.fieldValueOptions.checked:d.scope()[s]=a.fieldValueOptions.unchecked)),d.scope().hasOwnProperty(s)){var c=d.scope()[s];if(!angular.isDefined(c))return void(1!==o.globals.currentUser.per_developer&&a.field===i.groupItem&&(""===e.GROUP_ITEM?a.valueObject={field:a.field,value:o.globals.currentUser[(e.GROUP_TABLE+"_"+e.GROUP_ITEM_SUFFIX).toLowerCase()]}:a.valueObject={field:a.field,value:o.globals.currentUser[e.GROUP_ITEM.toLowerCase()]}));var p=a.field,f=c;"date"===a.type&&(f=u.moment(f).format("YYYY/MM/DD HH:mm:ss")),angular.isDefined(a.fieldValueOptions)&&"checkbox"!==d[0].type&&(p=a.fieldValueOptions.field,c?(f=c[a.fieldValueOptions.selectedItem],angular.isDefined(f)||(f=c[a.fieldValueOptions.selectedItem.toUpperCase()]),"%"===f&&(f=null)):f=null,angular.isDefined(d.scope().labelField)?angular.isDefined(c[d.scope().labelField])?a.labelField={field:d.scope().labelField,value:c[d.scope().labelField]}:a.labelField={field:d.scope().labelField,value:c[d.scope().labelField.toUpperCase()]}:angular.isDefined(a.fieldValueOptions.selectedLabel)&&(a.labelField={field:a.labelField,value:c[a.fieldValueOptions.selectedLabel]})),null!==f&&""!==f?a.valueObject={field:p,value:f}:"string"===a.type?a.valueObject={field:p,value:""}:(a.valueObject={},a.insert=!1,a.update=!1)}else a.valueObject={},a.insert=!1,a.update=!1}else angular.isDefined(a.user)&&a.user?(a.type="int",a.valueObject={field:a.field,value:o.globals.currentUser.usu_id}):angular.isDefined(a.insertGetDate)&&a.insertGetDate?"insert"===l?(a.type="datetime",a.valueObject={field:a.field,value:"",getDate:!0}):a.update=!1:angular.isDefined(a.updateGetDate)&&a.updateGetDate?(a.type="datetime",a.valueObject={field:a.field,value:"",getDate:!0}):!angular.isDefined(a["default"])||angular.isDefined(a.valueObject.value)&&null!==a.valueObject.value&&""!==a.valueObject.value?a.valueObject={field:a.field,value:""}:a.valueObject.value=a["default"]}),i.debug&&(console.group("$scope.insertUpdate"),console.info("action:",l),console.info("table:",s),console.info("fields (new):",d),console.info("oldForm:",i.oldForm),console.groupEnd());var p="";angular.isDefined(i.oldForm)&&(p=angular.toJson(i.oldForm)),a.insertUpdate(l,s,angular.toJson(d),p,function(e){i.debug&&console.info("pxFormService.insertUpdate response: ",e),e.data.success?(e.data.unique?angular.forEach(d,function(e){if(e.pk===!0){var a=angular.element($(e.selectorName).get(0)),l=a.data("$ngModelController");l.$setValidity("unique",!1),t[e.selectorName]=angular.copy(l.$modelValue),r(function(){a.trigger("blur")},0)}}):i.clean(),i.callback&&i.callback({event:e.data})):alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!")})},i.select=function(e){r(function(){var t=JSON.parse(i.config),o=t.table,s=t.view,d=t.fields;angular.isDefined(o)||(o=i.table),angular.isDefined(s)||(s=i.view),angular.isDefined(d)||(d=JSON.parse(i.fields)),angular.forEach(d,function(a){if(a.valueObject={},a.valueObject.value=e[a.field],angular.isDefined(a.select)?a.select=!1:a.select=!0,angular.isDefined(angular.element($("#"+a.element+"_inputSearch").get(0)).scope()))if(""!==angular.element($("#"+a.element+"_inputSearch").get(0)).scope().fields){var l=angular.element($("#"+a.element+"_inputSearch").get(0)).scope().fields;angular.forEach(l,function(e){e.labelField&&d.push({field:e.field,select:!0})})}else console.error("pxForm: componente px-input-search com propriedade fields inválida",a)}),i.debug&&(console.group("$scope.select"),console.info("table:",o),console.info("view:",s),console.info("fields:",d),console.groupEnd()),angular.isDefined(s)&&""!==s&&(o=s),a.select(o,angular.toJson(d),function(e){i.debug&&console.info("pxFormService.select response: ",e),e.data.success?(i.oldForm=e.data.qQuery[0],angular.forEach(d,function(a){if(angular.isDefined(a.element)){var i="#"+a.element,t=a.element,o=!1;if(angular.isDefined(angular.element($(i+"_inputSearch").get(0)).scope())){i+="_inputSearch",t="selectedItem";var o=!0}var s=angular.element($(i).get(0)),d=String(e.data.qQuery[0][a.field]);if(angular.isDefined(e.data.qQuery[0][a.field])||(d=String(e.data.qQuery[0][a.field.toUpperCase()])),!angular.isDefined(s[0]))return void console.error("pxForm: elemento não encontrado no html, verifique a propriedade element",a);if("checkbox"===s[0].type?d=angular.isDefined(a.fieldValueOptions)?String(a.fieldValueOptions.checked)===String(d)?!0:!1:"1"===d?!0:!1:a.pad&&(d=n.pad(a.pad,d,!0)),angular.isDefined(a.fieldValueOptions)&&"checkbox"!==s[0].type)if(s.scope().hasOwnProperty(t))if(o){var c=angular.copy(e.data.qQuery[0]);angular.isDefined(a.fieldValueOptions.selectedItem)||console.error("pxForm: selectedItem não definido em fieldValueOptions",a),c[a.fieldValueOptions.selectedItem]=d,s.scope().setValue(c)}else("bigint"===a.type||"bit"===a.type||"decimal"===a.type||"double"===a.type||"float"===a.type||"integer"===a.type||"money"===a.type||"money4"===a.type||"numeric"===a.type||"real"===a.type||"smallint"===a.type||"tinyint"===a.type||"int"===a.type)&&(d=Number(d)),s.scope()[a.field]=s.scope()[a.field][l.getIndexByProperty(s.scope()[a.field],a.fieldValueOptions.selectedItem,d)];else console.error("pxForm:","Scope "+t+" sem valor inicial definido");else s.scope().pxForm=!0,angular.isDefined(s.scope().pxForm2mask)&&(s.scope().cleanValue=d,s.scope().pxForm2mask(d)),"date"===a.type&&""!==d?(d=u.moment(d)._d,s.scope()[a.field]=d):"date"!==a.type&&(s.scope()[a.field]=d,r(function(){s.trigger("keyup")},0))}}),i.callback&&(e.data.action="select",i.callback({event:e.data}))):alert("Ops! Ocorreu um erro inesperado.\nPor favor contate o administrador do sistema!")})},0)},i.clean=function(){if(angular.isDefined(i.config)&&""!==i.config){var e=JSON.parse(i.config),a=e.table,l=e.fields;angular.isDefined(a)||(a=i.table),angular.isDefined(l)||(l=JSON.parse(i.fields)),angular.forEach(l,function(e){if(e.valueObject={},angular.isDefined(e.element)){var a="#"+e.element,l=e.element;angular.isDefined(angular.element($(a+"_inputSearch").get(0)).scope())&&(a+="_inputSearch",l="selectedItem");var n=angular.element($(a).get(0)),i="";angular.isDefined(e.fieldValueOptions)?n.scope().hasOwnProperty(l)&&(n.scope()[e.field]=i):n.scope()[e.field]=i}})}}}e.directive("pxForm",["$timeout",function(e){return{restrict:"E",replace:!1,transclude:!1,template:"<div></div>",scope:{debug:"=pxDebug",config:"@pxConfig",view:"@pxView",table:"@pxTable",fields:"@pxFields",init:"&pxInit",callback:"&pxCallback",control:"=pxControl"},link:function(a,l,n){a.internalControl=a.control||{},a.internalControl.insert=function(){a.insertUpdate("insert")},a.internalControl.select=function(e){a.select(e)},a.internalControl.update=function(){a.insertUpdate("update")},a.internalControl.clean=function(){a.clean()},e(a.init,0)},controller:a}}]),a.$inject=["pxConfig","pxFormService","pxArrayUtil","pxStringUtil","$scope","$http","$timeout","$rootScope","pxDateUtil"]});